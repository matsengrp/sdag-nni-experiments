#!/bin/bash
#SBATCH --cpus-per-task=1
#SBATCH --nodes=1
#SBATCH --exclusive
#SBATCH -o job_%j.out
#SBATCH -e job_%j.err
#SBATCH --mail-type=ALL
#SBATCH --mail-user=cjennin2@fredhutch.org

set -eu

# This script requires files generated by prep-ds-data.sh.


cd ../../


function prep_mb_data() {
    ds=$1
    root=$2
    prior_path=$3
    prior_str=$4

    echo "### Preparing Mr. Bayes data files for ds${ds} in ${prior_path}..."

    fasta_path="data/${ds}/${ds}.fasta"
    data_path="data/${ds}/${prior_path}"
    posterior_pickle_path="${data_path}/posterior.pkl" 
    first_tree_path="${data_path}/${ds}.top1.nwk" 
    posterior_newick_path="${data_path}/${ds}.mb-trees.with-fake_branches.nwk"
    pp_csv="${data_path}/${ds}.mb-pp.csv"
    pcsp_pp_csv="${data_path}/${ds}.pcsp-pp.csv"
    subsplit_path="${data_path}/${ds}.subsplit.csv"
    mb_run_dir="${data_path}/short_mcmc"
    mb_run_path="${mb_run_dir}/run.mb"
    rerooted_topologies_path="${mb_run_dir}/rerooted-topology-sequence.tab"
    out_path="${mb_run_dir}/mcmc_search_sdag_stats.time.csv"    


    echo "### Calculating statistics w/ run-time..."
    python mb_comparison_stats.py $posterior_pickle_path $rerooted_topologies_path \
      $fasta_path $first_tree_path $posterior_newick_path $pp_csv $pcsp_pp_csv \
      $subsplit_path $out_path

    echo "### Results written to ${mb_run_dir}"
}

prep_mb_data flu100 1 "_output" "unconstrained:uniform(0,1)"



#!/bin/bash

set -eu

# This script requires files generated by prep-ds-data.sh.

declare -A ds_roots=( [1]=15 [3]=7 [4]=8 [5]=1 [6]=6 [7]=7 [8]=4 )
declare -A priors=( ["_output"]="unconstrained:uniform(0,1)" ["_exp_output"]="unconstrained:exp(10.0)")


function prep_mb_data() {
    ds=$1
    root=$2
    prior_path=$3
    prior_str=$4

    echo "### Preparing Mr. Bayes data files for ds${ds} in ${prior_path}..."

    fasta_path="data/ds${ds}/ds${ds}.fasta"
    data_path="data/ds${ds}/${prior_path}"
    posterior_pickle_path="${data_path}/posterior.pkl" 
    first_tree_path="${data_path}/ds${ds}.top1.nwk" 
    posterior_newick_path="${data_path}/ds${ds}.mb-trees.with-fake_branches.nwk"
    pp_csv="${data_path}/ds${ds}.mb-pp.csv"
    pcsp_pp_csv="${data_path}/ds${ds}.pcsp-pp.csv"
    subsplit_path="${dest_path}/ds${ds}.subsplit.csv"
    mb_run_dir="${data_path}/short_mcmc"
    mb_run_path="${mb_run_dir}/run.mb"
    rerooted_topologies_path="${mb_run_dir}/rerooted-topology-sequence.tab"
    out_path="${mb_run_dir}/mcmc_search_sdag_stats.csv"    

    mkdir -p $mb_run_dir

    # Create the Mr. Bayes file.
    python make_mb_file.py $ds $first_tree_path $prior_str $mb_run_path

    echo "### Running Mr. Bayes..."
    cd $mb_run_dir
    mb run.mb | tee mb.log

    echo "### Processing Mr. Bayes trees file..."
    awk '$1~/tree/ {print $NF}' ds${ds}.t | nw_topology - | nw_reroot - ${root} \
      | nw_order - | uniq -c | sed -e "s/^[ ]*//" -e "s/[ ]/\t/" \
      > rerooted-topology-sequence.tab
    cd ../../../..

    echo "### Calculating statistics..."
    python mb_comparison_stats.py $posterior_pickle_path $rerooted_topologies_path \
      $fasta_path $first_tree_path $posterior_newick_path $pp_csv $pcsp_pp_csv \
      $subsplit_path $out_path

    echo "### Results written to mb_run_dir="${data_path}/short_mcmc""


    # Next do a longer run, but skip the spanned sDAG stats.
    mb_timed_run_dir="${data_path}/short_mcmc/timing"
    mb_timed_run_path="${mb_timed_run_dir}/run.mb"
    rerooted_topologies_path="${mb_timed_run_dir}/rerooted-topology-sequence.tab"
    out_path="${mb_timed_run_dir}/mcmc_search_stats.csv"    

    # Create the Mr. Bayes file.
    mkdir -p $mb_timed_run_dir
    python make_mb_file.py $ds $first_tree_path $prior_str $mb_timed_run_path \
      --generations 1000000 

    echo "### Running Mr. Bayes..."
    cd $mb_timed_run_dir
    mb run.mb | tee mb.log

    echo "### Processing Mr. Bayes trees file..."
    awk '$1~/tree/ {print $NF}' ds${ds}.t | nw_topology - | nw_reroot - ${root} \
      | nw_order - | uniq -c | sed -e "s/^[ ]*//" -e "s/[ ]/\t/" \
      > rerooted-topology-sequence.tab
    cd ../../../../..

    echo "### Calculating statistics..."
    python mb_comparison_stats.py $posterior_pickle_path $rerooted_topologies_path \
      $fasta_path $first_tree_path $posterior_newick_path $pp_csv $pcsp_pp_csv \
      $subsplit_path $out_path --skip_sdag_stats

    echo "### Results written to ${mb_timed_run_dir}"
}

for ds in "${!ds_roots[@]}"; do
  root=${ds_roots[$ds]}
  for prior_path in "${!priors[@]}"; do
    prior_string=${priors[$prior_path]}
    prep_mb_data $ds $root $prior_path $prior_string
  done
done









